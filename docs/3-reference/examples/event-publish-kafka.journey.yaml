apiVersion: v1
kind: Journey
metadata:
  name: event-publish-kafka
  version: 0.1.0
  description: Publish an order event to Kafka using DataWeave mappers.
spec:
  input:
    schema:
      title: event-publish-kafka input context
      type: object
      required: [orderId, amount, status]
      properties:
        orderId:
          type: string
        amount:
          type: number
        status:
          type: string
        traceparent:
          type: string
      additionalProperties: true
  output:
    schema:
      title: event-publish-kafka output
      type: object
      properties:
        orderId:
          type: string
        amount:
          type: number
        status:
          type: string
      additionalProperties: true

  start: emitEvent
  states:
    emitEvent:
      type: task
      task:
        kind: eventPublish
        eventPublish:
          transport: kafka
          topic: orders.events
          key:
            mapper:
              lang: dataweave
              expr: |
                context.orderId
          value:
            mapper:
              lang: dataweave
              expr: |
                {
                  eventType: "ORDER_UPDATED",
                  orderId: context.orderId,
                  amount: context.amount,
                  status: context.status
                }
          headers:
            traceparent: "${context.traceparent}"
            source: "journeyforge"
      next: done

    done:
      type: succeed
      # The journey does not rely on publish outcome; it can simply return context or a subset.
