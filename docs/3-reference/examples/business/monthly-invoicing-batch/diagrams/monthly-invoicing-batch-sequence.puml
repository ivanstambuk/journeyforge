@startuml
!include journey-diagram-theme.puml
title monthly-invoicing-batch â€“ sequence

actor ConfigUI as ConfigUI
actor FinanceUI as FinanceUI
participant "Journeys API" as Journeys
participant "Billing API" as Billing

== Configure and schedule ==

ConfigUI -> Journeys : POST /journeys/monthly-invoicing-batch/start\n(startRequest)
Journeys -> Journeys : configureSchedule\n(task.kind: schedule:v1)
Journeys --> ConfigUI : 200 OK (JourneyOutcome, status=SCHEDULED)

ConfigUI -> Journeys : GET /journeys/{journeyId}
Journeys --> ConfigUI : JourneyStatus (Running/Succeeded)

ConfigUI -> Journeys : GET /journeys/{journeyId}/result
Journeys --> ConfigUI : JourneyOutcome (status=SCHEDULED)

== Scheduled run: draft, validate, approve, send, chase ==

Journeys -> Billing : draftInvoicesForBatch
Billing --> Journeys : draftResult

Journeys -> Billing : validateInvoiceBatch
Billing --> Journeys : validationResult

FinanceUI -> Journeys : POST /journeys/{journeyId}/steps/approveInvoiceBatch\n(approvalDecision)
Journeys --> FinanceUI : InvoiceBatchApprovalStepResponse

Journeys -> Billing : sendInvoiceBatch
Billing --> Journeys : sendResult

Journeys -> Billing : sendInvoiceReminder
Billing --> Journeys : reminderResult

Journeys -> Billing : sendInvoiceFinalNotice
Billing --> Journeys : finalNoticeResult

@enduml
