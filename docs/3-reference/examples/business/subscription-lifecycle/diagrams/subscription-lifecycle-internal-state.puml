@startuml
!include journey-diagram-theme.puml
title subscription-lifecycle – internal DSL state graph

[*] --> createTrial

state createTrial
state trialWaitOrExpire
state waitForUpgrade
state activationOutcomeInitial
state activationRetryDelay
state retryActivatePaid
state activationOutcomeRetry
state activationFailed
state trialExpired
state trialOutcomeSwitch
state activatePaid
state statusChangeOrTimeout
state completeActive
state completeCancelled
state completeReactivated

createTrial --> trialWaitOrExpire : createTrialSubscription\nresultVar: trial

trialWaitOrExpire --> trialOutcomeSwitch : parallel(waitForUpgrade vs trialTimer)\ntrialOutcome set

trialOutcomeSwitch --> activatePaid : trialOutcome == "UPGRADED"
trialOutcomeSwitch --> trialExpired : trialOutcome == "EXPIRED"

activatePaid --> activationOutcomeInitial : activateSubscription (first attempt)

activationOutcomeInitial --> statusChangeOrTimeout : activation.ok == true
activationOutcomeInitial --> activationRetryDelay : activation.ok != true

activationRetryDelay --> retryActivatePaid : wait PT4H

retryActivatePaid --> activationOutcomeRetry : activateSubscription (second attempt)

activationOutcomeRetry --> statusChangeOrTimeout : activation.ok == true
activationOutcomeRetry --> activationFailed : activation.ok != true

statusChangeOrTimeout --> completeCancelled : action == "cancel"
statusChangeOrTimeout --> completeReactivated : action == "reactivate"
statusChangeOrTimeout --> completeActive : timer branch or default

trialExpired --> [*]
completeActive --> [*]
completeCancelled --> [*]
completeReactivated --> [*]
activationFailed --> [*]

note right of trialWaitOrExpire
  type: parallel
  branches:
    - waitForUpgrade (wait step)
    - trialTimer (timer; trialDays or 14d)
  join.strategy: anyOf
  sets trialOutcome to UPGRADED or EXPIRED
end note

note right of activatePaid
  First activation attempt via subscriptions.activateSubscription.
  On failure, activationOutcomeInitial routes to a 4h
  backoff timer and a second activation attempt; if that
  also fails, activationFailed terminates with ACTIVATION_FAILED.
end note

note right of statusChangeOrTimeout
  type: parallel
  branches:
    - waitForStatusChange (wait step – cancel/reactivate)
    - statusChangeTimer (timer P30D)
  join.strategy: anyOf
  cancel/reactivate complete via dedicated states;
  timer branch auto-completes as ACTIVE
end note

@enduml
