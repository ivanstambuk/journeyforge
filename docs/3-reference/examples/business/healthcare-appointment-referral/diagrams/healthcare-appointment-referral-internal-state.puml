@startuml
!include journey-diagram-theme.puml
title healthcare-appointment-referral â€“ internal DSL state graph

[*] --> initialiseReferral

state initialiseReferral
state referralOrExpiry

state requestAppointments
state normaliseAppointments
state patientDecision
state bookConfirmedAppointment
state waitForAppointmentStatus
state completePatientCancelled
state completeAppointmentConfirmed
state completeAppointmentCompleted
state noProviderAvailable

state referralExpiryTimer
state markReferralExpired

state referralCompleted

initialiseReferral --> referralOrExpiry

referralOrExpiry --> requestAppointments : referralBranch
referralOrExpiry --> referralExpiryTimer : expiryBranch

requestAppointments --> normaliseAppointments
normaliseAppointments --> patientDecision

patientDecision --> completePatientCancelled : action == CANCEL
patientDecision --> requestAppointments : action == RESCHEDULE
patientDecision --> bookConfirmedAppointment : action == CONFIRM
patientDecision --> patientDecision : otherwise

bookConfirmedAppointment --> waitForAppointmentStatus

waitForAppointmentStatus --> completeAppointmentConfirmed : status == CONFIRMED
waitForAppointmentStatus --> completeAppointmentCompleted : status == COMPLETED
waitForAppointmentStatus --> noProviderAvailable : status == CANCELLED or FAILED

completePatientCancelled --> referralCompleted
completeAppointmentConfirmed --> referralCompleted
completeAppointmentCompleted --> referralCompleted
noProviderAvailable --> referralCompleted

referralExpiryTimer --> markReferralExpired
markReferralExpired --> referralCompleted

referralCompleted --> [*]

note right of patientDecision
  Generic patient step that accepts
  action (CONFIRM, RESCHEDULE, CANCEL)
  and an appointmentId, updates the
  appointments array, and chooses
  the next branch based on action.
end note

note right of referralExpiryTimer
  Timer enforcing referral-level expiry
  based on referralExpiryDays; if it fires
  before an outcome is reached, the referral
  is completed as EXPIRED.
end note

@enduml

