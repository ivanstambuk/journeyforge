@startuml
!include journey-diagram-theme.puml
title travel-booking-bundle â€“ internal DSL state graph

[*] --> reserveBundle

state reserveBundle
state evaluateReservations
state waitForTravelerConfirmation
state initiatePayment
state waitForTripUpdates
state changeOrCancelOrTimeout
state prepareOutcome
state completeTrip
state completeCancelled
state bookingFailed
state failed

reserveBundle --> evaluateReservations : flights.createFlightBooking,\nhotels.createHotelBooking,\ncars.createCarBooking\nresultVar: reservations

evaluateReservations --> waitForTravelerConfirmation : at least one segment reserved
evaluateReservations --> bookingFailed : default (no segments reserved)

waitForTravelerConfirmation --> initiatePayment : payload.decision == "confirm"
waitForTravelerConfirmation --> completeCancelled : decision == "cancel"

initiatePayment --> waitForTripUpdates : payments.authorizePayment

waitForTripUpdates --> changeOrCancelOrTimeout : status == CONFIRMED\nor PARTIALLY_CONFIRMED
waitForTripUpdates --> prepareOutcome : status == CANCELLED
waitForTripUpdates --> failed : default (FAILED or unexpected)

changeOrCancelOrTimeout --> prepareOutcome : any action within change window\nor when change window expires

prepareOutcome --> completeTrip
completeTrip --> [*]

completeCancelled --> [*]
bookingFailed --> [*]
failed --> [*]

note right of waitForTravelerConfirmation
  type: wait (manual channel)
  step id: confirmBundle
  input: TravelerConfirmationInput
end note

note right of waitForTripUpdates
  type: webhook (aggregated provider callback)
  step id: waitForTripUpdates
  security: X-Trip-Update-Secret
end note

note right of changeOrCancelOrTimeout
  type: parallel
  branches:
    - changeOrCancelBranch (wait step: changeOrCancel)
    - changeWindowBranch (timer-based change window)
end note

@enduml
