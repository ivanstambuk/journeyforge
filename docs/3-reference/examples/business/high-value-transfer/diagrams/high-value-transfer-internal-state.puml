@startuml
!include journey-diagram-theme.puml
title high-value-transfer â€“ internal DSL state graph

[*] --> runChecks

state runChecks
state evaluateChecks
state waitForApproval
state initiateTransfer
state awaitSettlementOrTimeout
state notifySettlementTimeout
state rejected

runChecks --> evaluateChecks : fraud.checkTransfer &\nsanctions.screenTransfer\nresultVar: checks

evaluateChecks --> waitForApproval : checks.fraud.ok &&\nchecks.sanctions.ok
evaluateChecks --> rejected : default (checks failed)

waitForApproval --> initiateTransfer : payload.decision == "approve"
waitForApproval --> rejected : decision == "reject"

initiateTransfer --> awaitSettlementOrTimeout : transfers.initiateHighValueTransfer

awaitSettlementOrTimeout --> [*] : settlement success,\nprovider failure, or timeout\n(with SLA breach notification on timeout)

rejected --> [*]

note right of runChecks
  type: parallel
  branches: fraud, sanctions
  join.strategy: allOf
  join.resultVar: checks
end note

note right of waitForApproval
  type: wait (manual channel)
  step id: approveTransfer
  input: ApproveTransferInput
end note

note right of awaitSettlementOrTimeout
  type: parallel (settlement vs timeout)
  settlementBranch:
    - state: waitForSettlement (webhook)
    - status == "SETTLED" -> success
    - status == "FAILED" -> HIGH_VALUE_TRANSFER_FAILED
  timeoutBranch:
    - state: settlementTimer (timer PT30M)
    - on timer firing, call transfers.notifySettlementTimeout
    - then fail with HIGH_VALUE_TRANSFER_SETTLEMENT_TIMEOUT
  join.strategy: anyOf
end note

@enduml
