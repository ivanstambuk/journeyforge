@startuml
!include journey-diagram-theme.puml
title support-case-sla â€“ internal DSL state graph

[*] --> classifyPriority

state classifyPriority
state notifyAssignment
state waitOrEscalateOrGiveUp
state waitForAgentUpdate
state ignoreUpdate
state markResolved
state caseResolved
state slaTimer
state markEscalated
state notifyEscalation
state caseEscalated
state giveUpTimer
state markAutoClosed
state caseAutoClosed

classifyPriority --> notifyAssignment : compute slaDuration + giveUpDuration
notifyAssignment --> waitOrEscalateOrGiveUp : POST support.example.com/cases/assign

waitOrEscalateOrGiveUp --> waitForAgentUpdate : branch caseWorkBranch
waitOrEscalateOrGiveUp --> slaTimer : branch slaBranch
waitOrEscalateOrGiveUp --> giveUpTimer : branch giveUpBranch

waitForAgentUpdate --> markResolved : payload.status == "RESOLVED"
waitForAgentUpdate --> ignoreUpdate : default (non-resolving update)

ignoreUpdate --> waitForAgentUpdate

markResolved --> caseResolved
caseResolved --> [*]

slaTimer --> markEscalated
markEscalated --> notifyEscalation
notifyEscalation --> caseEscalated
caseEscalated --> [*]

giveUpTimer --> markAutoClosed
markAutoClosed --> caseAutoClosed
caseAutoClosed --> [*]

note right of waitForAgentUpdate
  type: wait (manual channel)
  step id: waitForAgentUpdate
  input: SupportCaseAgentUpdateInput
end note

note right of slaTimer
  type: timer
  duration: context.slaDuration
  represents the response SLA window based on priority
end note

note right of giveUpTimer
  type: timer
  duration: context.giveUpDuration (default P2D)
  represents a longer give-up window\nbefore the case is auto-closed
end note

@enduml
