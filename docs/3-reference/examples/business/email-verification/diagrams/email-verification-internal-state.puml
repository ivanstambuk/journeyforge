@startuml
!include journey-diagram-theme.puml
title email-verification â€“ internal DSL state graph

[*] --> generateVerificationCode

state generateVerificationCode
state sendVerificationEmail
state waitOrExpire
state waitForVerification
state markVerified
state invalidCode
state firstReminderTimer
state sendFirstReminder
state recordFirstReminder
state secondReminderTimer
state sendSecondReminder
state recordSecondReminder
state verificationTimer
state markExpired
state journeyDoneVerified
state journeyDoneExpired
state notifyExpired

generateVerificationCode --> sendVerificationEmail : uuid() -> context.verificationCode
sendVerificationEmail --> waitOrExpire : notifications.email/verification\n(userId, email, verificationCode)

waitOrExpire --> waitForVerification : branch waitBranch\n(wait step)
waitOrExpire --> firstReminderTimer : branch expiryBranch\n(reminders + expiry window)

waitForVerification --> markVerified : payload.code == context.verificationCode
waitForVerification --> invalidCode : default

markVerified --> journeyDoneVerified
journeyDoneVerified --> [*]

firstReminderTimer --> sendFirstReminder
sendFirstReminder --> recordFirstReminder
recordFirstReminder --> secondReminderTimer

secondReminderTimer --> sendSecondReminder
sendSecondReminder --> recordSecondReminder
recordSecondReminder --> verificationTimer

verificationTimer --> markExpired
markExpired --> notifyExpired
notifyExpired --> journeyDoneExpired
journeyDoneExpired --> [*]

invalidCode --> [*]

note right of waitForVerification
  type: wait (manual channel)
  step id: waitForVerification
  input: { code: string }
  compares code to context.verificationCode
end note

note right of firstReminderTimer
  type: timer
  duration: P1D
  triggers first reminder email\nwhen no verification has occurred
end note

note right of secondReminderTimer
  type: timer
  duration: P2D
  triggers second reminder email\nwhen still unverified
end note

note right of verificationTimer
  type: timer
  duration: P4D
  completes 7-day window\nbefore marking EXPIRED
end note

@enduml
