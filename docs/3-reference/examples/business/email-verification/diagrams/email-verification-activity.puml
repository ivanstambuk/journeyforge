@startuml
!include journey-diagram-theme.puml
title email-verification â€“ client activity flow

start

:Client sends\nPOST /api/v1/journeys/email-verification/start\nwith EmailVerificationStartRequest;

:Client (or adapter) stores journeyId\nand constructs a magic link that\ncontains journeyId + verification code;

if (User clicks magic link\nwithin 7 days?) then (yes)
  :Adapter extracts\njourneyId + code\nand calls\nPOST /journeys/{journeyId}/steps/waitForVerification;
else (no)
  :No verification call is made yet;\nengine continues waiting;
endif

repeat
  :Client calls\nGET /journeys/{journeyId}/result;
  :Journeys API returns\nJourneyOutcome with phase/output;
repeat while (phase == "Running") is (still waiting)

if (output.status == "VERIFIED"?) then (verified)
  :Client marks email as verified\nand updates local profile;
  stop
else (expired)
  :Client shows an "expired link"\nmessage and may offer to resend\nverification;\nengine may also have sent\none or more reminders and a\npost-expiry notification;
  stop
endif

@enduml
