@startuml
!include journey-diagram-theme.puml
title email-verification â€“ sequence

actor "Client" as Client
actor "Email service" as EmailService
actor "Email link adapter" as Adapter
participant "Journeys API" as Journeys

Client -> Journeys: POST /api/v1/journeys/email-verification/start\nEmailVerificationStartRequest
Journeys -> EmailService: POST /email/verification\n(userId, email, verificationCode)
EmailService --> Journeys: 202 Accepted\n(email queued)
Journeys --> Client: 200 OK\nJourneyStatus (email sent,\nwaiting for verification)

note over Client, Adapter
  User receives the email and clicks the magic link
  in the adapter/channel, which extracts journeyId
  and verification code before calling the journey.
end note

Adapter -> Journeys: POST /api/v1/journeys/{journeyId}/steps/waitForVerification\nEmailVerificationStepInput (code)
Journeys --> Adapter: 200 OK\nEmailVerificationStepResponse\n(phase, currentState, verified)

== Reminders and expiry ==

... After 1 day with no verification ...
Journeys -> EmailService: POST /email/verification/reminder\n(first reminder)
EmailService --> Journeys: 202 Accepted\n(reminder queued)

... After another 2 days with no verification ...
Journeys -> EmailService: POST /email/verification/reminder\n(second reminder)
EmailService --> Journeys: 202 Accepted\n(reminder queued)

... After a further 4 days with no verification ...
Journeys -> EmailService: POST /email/verification/expired\n(post-expiry notification)
EmailService --> Journeys: 202 Accepted\n(notification queued)

Client -> Journeys: GET /api/v1/journeys/{journeyId}\n(getStatusAfterVerification)
Journeys --> Client: 200 OK\nJourneyStatus (verification processed)

Client -> Journeys: GET /api/v1/journeys/{journeyId}/result\n(getResult)
Journeys --> Client: 200 OK\nJourneyOutcome\n(status == VERIFIED or EXPIRED,\nmirroring output.status)

@enduml
